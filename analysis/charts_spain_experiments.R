# Load data (generated by process_spain_provinces_data.R  script)
data_cases_sp_provinces <- readRDS(file = "data/output/spain/covid19-provincias-spain_consolidated.rds")


noprevalentes <- c("")
updated <- ""
period <- "(Actualizado: 2020-09-14)"
filter_date <- as.Date("2020-09-15")

# 13. Todos los datos juntos ------------
# Calcula máximos
maxs <- data_cases_sp_provinces %>% group_by(province) %>% 
  filter( date > filter_date -40 ) %>%
  # filter( date > as.Date("2020-03-01") & date < as.Date("2020-05-30") ) %>% 
  summarise(
    max_daily_cases_PCR_avg7 = max(replace_na(daily_cases_PCR_avg7,0)),
    max_hospitalized = max(replace_na(hospitalized,0)),
    max_intensive_care = max(replace_na(intensive_care,0)),
    max_daily_deaths_avg7 = max(replace_na(daily_deaths_avg7,0)),
  )

all <- merge (data_cases_sp_provinces,
              maxs,
              by.x = "province", by.y = "province")




png(filename=paste("img/spain/experiments/covid19_todo-junto-provincia-lineal.png", sep = ""),width = 1500,height = 1000)
data_cases_sp_provinces %>% filter( ! ccaa %in% noprevalentes ) %>% filter( date > filter_date -50 ) %>%
  # filter( province == "Madrid") %>%
  ggplot() +
  geom_line(aes(date, daily_cases_PCR_avg7,group=province, color="#5b5bbb"), size=0.8 ) +
  # geom_line(aes(date, hospitalized,group=province, color="violet"), size=0.8 ) +
  # geom_line(aes(date, intensive_care*10,group=province, color= "red"), size=0.8 ) +
  # geom_line(aes(date, daily_deaths_avg7*100,group=province, color= "black"), size=0.8 ) +
  geom_line(aes(date-3, hospitalized *1,group=province, color="violet"), size=0.8 ) +
  geom_line(aes(date-3, intensive_care*10.5,group=province, color= "red"), size=0.8 ) +
  geom_line(aes(date-12, daily_deaths_avg7*105,group=province, color= "black"), size=0.8 ) +
  scale_color_identity(
    guide = "legend",
    labels = c("Casos PCR+","Fallecidos x100","UCI x10","Hospitalizados x1"),
  ) +
  expand_limits(y = 0) +
  facet_wrap(~province, scales = "free_y") +
  scale_y_continuous(
    # limits = c(0,max(data_cases_sp_provincesX$cases_accumulated) ),
    labels=function(x) format(round(x, digits = 0), big.mark = ".", scientific = FALSE) ) +
  scale_x_date(date_breaks = "1 month", 
               date_labels = "%m",
               limits=c( filter_date -50, max(data_cases_sp_provinces$date)),
               expand = c(0,0) 
  ) + 
  theme_minimal(base_family = "Roboto Condensed",base_size = 20) +
  theme(
    panel.grid.minor.x = element_blank(),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.y = element_blank(),
    axis.ticks.x = element_line(color = "#000000"),
    legend.position = "top",
    axis.text.x = element_text(size = 10)
  ) +
  labs(title = paste0("Comparativa: Casos PCR+, Hospitalizados, UCI, Fallecidos diaros por COVID-19 en España ", updated ),
       subtitle = paste0("Se multiplican las series: Fallecidos x100, UCI x10 ",period),
       y = "",
       x = "fecha (mes) 2020",
       color = "",
       caption = caption_provincia)
dev.off()

for (i in 1:4) {
  png(filename=paste("img/spain/experiments/covid19_todo-junto-provincia-lineal_norm-",i,".png", sep = ""),width = 1200,height = 800)
  the_plot <- all %>% filter( ! ccaa %in% noprevalentes ) %>% 
    filter( date > filter_date - 40 ) %>%
    # filter( date > as.Date("2020-03-01") & date < as.Date("2020-05-30") ) %>% 
    # filter( max_daily_cases_PCR_avg7 > 50) %>%
    filter( max_daily_cases_PCR_avg7 > 40) %>%
    # filter( max_daily_deaths_avg7 > 1) %>%
    ggplot() 
  if( i == 1) {
    the_plot <- the_plot + geom_line(aes(date, daily_cases_PCR_avg7 / max_daily_cases_PCR_avg7 *100,group=province, color="#5b5bbb"), size=0.8 ) +
      scale_color_identity(
        guide = "legend",
        labels = c("Casos PCR+")
      ) 
  }
  if( i == 2) {
    the_plot <- the_plot + geom_line(aes(date, daily_cases_PCR_avg7 / max_daily_cases_PCR_avg7 *100,group=province, color="#5b5bbb"), size=0.8 ) +
      geom_line(aes(date, hospitalized / max_hospitalized *100, group=province, color="violet"), size=0.8 ) +
      scale_color_identity(
        guide = "legend",
        labels = c("Casos PCR+","Hospitalizados"), )
  }
  if( i == 3) {
    the_plot <- the_plot + geom_line(aes(date, daily_cases_PCR_avg7 / max_daily_cases_PCR_avg7 *100,group=province, color="#5b5bbb"), size=0.8 ) +
      geom_line(aes(date, hospitalized / max_hospitalized *100, group=province, color="violet"), size=0.8 ) +
      geom_line(aes(date, intensive_care / max_intensive_care *100 ,group=province, color= "red"), size=0.8 ) +
      scale_color_identity(
        guide = "legend",
        labels = c("Casos PCR+","UCI","Hospitalizados"), )
  }
  if( i == 4) {
    the_plot <- the_plot + geom_line(aes(date, daily_cases_PCR_avg7 / max_daily_cases_PCR_avg7 *100,group=province, color="#5b5bbb"), size=0.8 ) +
      geom_line(aes(date, hospitalized / max_hospitalized *100, group=province, color="violet"), size=0.8 ) +
      geom_line(aes(date, intensive_care / max_intensive_care *100 ,group=province, color= "red"), size=0.8 ) +
      geom_line(aes(date, daily_deaths_avg7 / max_daily_deaths_avg7 *100, group=province, color= "black"), size=0.8 ) +
      scale_color_identity(
        guide = "legend",
        labels = c("Casos PCR+","Fallecidos","UCI","Hospitalizados"), )
  }
  
  the_plot <- the_plot +
    expand_limits(y = 0) +
    facet_wrap(~province) +
    coord_cartesian(
      ylim = c(0,100)
    ) +
    scale_y_continuous(
      # limits = c(0,max(data_cases_sp_provincesX$cases_accumulated) ),
      labels=function(x) format(round(x, digits = 0), big.mark = ".", scientific = FALSE) ) +
    scale_x_date(date_breaks = "1 week", 
                 date_labels = "%d/%m",
                 limits=c( filter_date -40, max(data_cases_sp_provinces$date)),
                 # limits=c( as.Date("2020-03-01"), as.Date("2020-05-30")),
                 expand = c(0,0) 
    ) + 
    theme_minimal(base_family = "Roboto Condensed",base_size = 20) +
    theme(
      panel.grid.minor.x = element_blank(),
      panel.grid.major.x = element_blank(),
      panel.grid.major.y = element_blank(),
      panel.grid.minor.y = element_blank(),
      axis.ticks.x = element_line(color = "#000000"),
      legend.position = "top",
      axis.text.x = element_text(size = 11)
    ) +
    labs(title = paste0("Casos PCR+, Hospitalizados, UCI, Fallecidos diaros por COVID-19 en España ", updated ),
         subtitle = paste0("Valores normalizados de 0 a 100 en el periodo analizado. ",period),
         y = "valores normalizados de 0 a 100",
         x = "2020",
         color = "",
         caption = caption_provincia)
  
  print(the_plot)
  dev.off()
}

# 14. Experimentos -----------------
data_cases_sp_provinces$weekday <- weekdays(data_cases_sp_provinces$date)

data_cases_sp_provinces$weekday <- factor(data_cases_sp_provinces$weekday, levels = c("lunes","martes", "miércoles", "jueves", "viernes",
                                                                                      "sábado","domingo" ) )

png(filename=paste0("img/spain/experiments/euskadi-experimento.png", sep = ""),width = 1200,height = 700)
data_cases_sp_provinces %>% filter ( (ccaa == "País Vasco" ) & (date > filter_date - 50) ) %>%
  ggplot() +
  geom_line(aes(date, daily_cases_PCR, group=weekday, color=weekday), size= 1) +
  geom_point(aes(date, daily_cases_PCR, color=weekday), size= 1.5 ) +
  facet_wrap( ~province, scales = "free_y") +
  geom_text_repel(
    data = data_cases_sp_provinces %>% filter(ccaa == "País Vasco" ) %>% group_by(weekday) %>% filter(!is.na(daily_cases_PCR) ) %>% top_n(1, date),
    aes(date, daily_cases_PCR, color=weekday,
        label=paste(weekday)),
    nudge_x = 1, # adjust the starting y position of the text label
    size=5,
    hjust=0,
    family = "Roboto Condensed",
    direction="y",
    segment.size = 0.1,
    segment.color="#777777"
  ) +
  # scale_color_manual(values = colors_prov) +
  scale_y_continuous( 
    labels=function(x) format(round(x, digits = 0), big.mark = ".", scientific = FALSE)
    # expand = c(0,0.2)
  ) +
  scale_x_date(date_breaks = "2 week", 
               date_labels = "%d/%m",
               limits=c( filter_date - 50, max(data_cases_sp_provinces$date) + 10),
               expand = c(0,0) 
  ) + 
  theme_minimal(base_family = "Roboto Condensed",base_size = 19) +
  theme(
    panel.grid.minor.x = element_blank(),
    panel.grid.major.x = element_blank(),
    # panel.grid.minor.y = element_blank(),
    axis.ticks.x = element_line(color = "#000000"),
    legend.position =  "top"
  ) +
  labs(title = paste0("Casos notificados por día de la semana. COVID-19 en ","País Vasco", " ", updated ),
       subtitle = paste0("Últimos 50 días. Por provincia. ",period),
       y = "casos PCR+ por día",
       x = "fecha",
       color = "Día de la semana",
       caption = caption_provincia) 

dev.off()

  png(filename=paste0("img/spain/experiments/madrid-experimento.png", sep = ""),width = 1000,height = 700)
data_cases_sp_provinces %>% filter ( (ccaa == "Madrid, Comunidad de" ) & (date > filter_date - 50) ) %>%
  ggplot() +
  geom_line(aes(date, daily_cases_PCR, group=weekday, color=weekday), size= 1) +
  geom_point(aes(date, daily_cases_PCR, color=weekday), size= 1.5 ) +
  facet_wrap( ~province, scales = "free_y") +
  geom_text_repel(
    data = data_cases_sp_provinces %>% filter( ccaa == "Madrid, Comunidad de" ) %>% group_by(weekday) %>% filter(!is.na(daily_cases_PCR) ) %>% top_n(1, date),
    aes(date, daily_cases_PCR, color=weekday,
        label=paste(weekday)),
    nudge_x = 1, # adjust the starting y position of the text label
    size=5,
    hjust=0,
    family = "Roboto Condensed",
    direction="y",
    segment.size = 0.1,
    segment.color="#777777"
  ) +
  # scale_color_manual(values = colors_prov) +
  scale_y_continuous( 
    labels=function(x) format(round(x, digits = 0), big.mark = ".", scientific = FALSE)
    # expand = c(0,0.2)
  ) +
  scale_x_date(date_breaks = "1 week", 
               date_labels = "%d/%m",
               limits=c( filter_date - 50, max(data_cases_sp_provinces$date) + 10),
               expand = c(0,0) 
  ) + 
  theme_minimal(base_family = "Roboto Condensed",base_size = 19) +
  theme(
    panel.grid.minor.x = element_blank(),
    panel.grid.major.x = element_blank(),
    # panel.grid.minor.y = element_blank(),
    axis.ticks.x = element_line(color = "#000000"),
    legend.position =  "top"
  ) +
  labs(title = paste0("Casos notificados por día de la semana. COVID-19 en C. de Madrid", " ", updated ),
       subtitle = paste0("Últimos 50 días. Por provincia. ",period),
       y = "casos PCR+ por día",
       x = "fecha",
       color = "Día de la semana",
       caption = caption_provincia) 
dev.off()

png(filename=paste0("img/spain/experiments/barcelona-experimento.png", sep = ""),width = 1000,height = 700)
data_cases_sp_provinces %>% filter ( (province == "Barcelona" ) & (date > filter_date - 50) ) %>%
  ggplot() +
  geom_line(aes(date, daily_cases_PCR, group=weekday, color=weekday), size= 1) +
  geom_point(aes(date, daily_cases_PCR, color=weekday), size= 1.5 ) +
  facet_wrap( ~province, scales = "free_y") +
  geom_text_repel(
    data = data_cases_sp_provinces %>% filter( province == "Barcelona" ) %>% group_by(weekday) %>% filter(!is.na(daily_cases_PCR) ) %>% top_n(1, date),
    aes(date, daily_cases_PCR, color=weekday,
        label=paste(weekday)),
    nudge_x = 1, # adjust the starting y position of the text label
    size=5,
    hjust=0,
    family = "Roboto Condensed",
    direction="y",
    segment.size = 0.1,
    segment.color="#777777"
  ) +
  # scale_color_manual(values = colors_prov) +
  scale_y_continuous( 
    labels=function(x) format(round(x, digits = 0), big.mark = ".", scientific = FALSE)
    # expand = c(0,0.2)
  ) +
  scale_x_date(date_breaks = "1 week", 
               date_labels = "%d/%m",
               limits=c( filter_date - 50, max(data_cases_sp_provinces$date) + 10),
               expand = c(0,0) 
  ) + 
  theme_minimal(base_family = "Roboto Condensed",base_size = 19) +
  theme(
    panel.grid.minor.x = element_blank(),
    panel.grid.major.x = element_blank(),
    # panel.grid.minor.y = element_blank(),
    axis.ticks.x = element_line(color = "#000000"),
    legend.position =  "top"
  ) +
  labs(title = paste0("Casos notificados por día de la semana. COVID-19 en ","Barcelona", " ", updated ),
       subtitle = paste0("Últimos 50 días. Por provincia. ",period),
       y = "casos PCR+ por día",
       x = "fecha",
       color = "Día de la semana",
       caption = caption_provincia) 

dev.off()




png(filename=paste0("img/spain/experiments/covid19_casos-dia-ccaa.png", sep = ""),width = 1000,height = 600)
spain_ccaa %>% mutate (
  daily_cases_PCR_avg7 = ifelse(ccaa =="Galicia", daily_cases_avg7, daily_cases_PCR_avg7)
  ) %>% filter ((date > filter_date - 60) &  date < filter_date - 7  ) %>%
  ggplot(aes(x = date, y = daily_cases_PCR_avg7 , fill = ccaa)) +
  geom_area(col = "black", lwd=0.1 ) +
  scale_fill_manual(values = colors_prov ) +
  # scale_fill_viridis_d() +
  annotate("text", x = as.Date("2020-08-15"), y = 3000,
           label = "Cataluña", size = 6, alpha = .7, angle = 15)  +
  annotate("text", x = as.Date("2020-08-21"), y = 1500,
           label = "C. de Madrid", size = 6, alpha = .7, angle = 10)  +
  scale_y_continuous( labels=function(x) format(round(x, digits = 1), big.mark = ".", scientific = FALSE)
  ) +
  scale_x_date(
    date_breaks = "1 week",
    date_labels = "%d/%m",
    # limits=c( min(municipios$date)+0, max(municipios$date)+1),
    expand = c(0,0)
  ) +
  theme_minimal(base_family = "Roboto Condensed",base_size = 16) +
  theme(
    panel.grid.minor.x = element_blank(),
    panel.grid.major.x = element_blank(),
    # panel.grid.minor.y = element_blank(),
    axis.ticks.x = element_line(color = "#000000"),
    legend.position =  "right"
  ) +
  labs(title = paste0("Media de casos por día (ventana de 7 días) por COVID-19 en España", updated ),
       subtitle = paste0("Últimos 50 días. Por comunidades autónomas. ", 
                         period),
       y = "casos por día (media 7 días)",
       x = "fecha",
       caption = caption_provincia)
dev.off()
